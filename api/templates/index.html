<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Solar</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        function forceLogout() { window.location.href = "/logout"; }
        try { if(performance.getEntriesByType("navigation")[0].type==="reload") forceLogout(); } catch(e){}
    </script>
    <style>
        :root { --primary: #2ecc71; --secondary: #27ae60; --dark: #2c3e50; --tab-bg: #dfe1e5; --tab-active: #ffffff; --danger: #e74c3c; }
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; max-width: 800px; margin: 0 auto 20px; }
        .logout-btn { background: var(--danger); color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-size: 14px; }
        .main-container { max-width: 98%; margin: 0 auto; }
        
        /* TAB BAR */
        .tab-bar { display: flex; align-items: flex-end; padding: 0 10px; border-bottom: 1px solid #ccc; justify-content: center; flex-wrap: wrap; }
        .tab-btn { padding: 10px 15px; background: var(--tab-bg); color: #5f6368; border: 1px solid #ccc; border-bottom: none; border-radius: 8px 8px 0 0; margin-right: -1px; cursor: pointer; font-weight: 500; font-size: 14px; }
        .tab-btn.active { background: var(--tab-active); color: var(--secondary); font-weight: bold; border-bottom: 1px solid var(--tab-active); padding-top: 12px; }
        .tab-content { background: white; border: 1px solid #ccc; border-radius: 0 8px 8px 8px; padding: 30px; display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* FORM ELEMENTS */
        label { display: block; margin: 15px 0 5px; font-weight: 500; font-size: 14px; color: #333;}
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-calc { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; font-weight: bold; font-size: 16px;}
        .btn-update { width: 100%; padding: 10px; background: var(--dark); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;}
        .alert { padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; margin-bottom: 15px; text-align: center;}
        
        /* TABLE & GRID */
        table { width: 100% !important; border-collapse: collapse; }
        .table th, .table td { border: 1px solid #ddd; padding: 10px; vertical-align: middle !important; }
        .text-center-input input { text-align: center; font-weight: bold; margin: 0 auto; max-width: 120px; display: block; }
        .col-center { text-align: center !important; }
        .btn-danger-circle { border-radius: 50% !important; width: 32px; height: 32px; padding: 0 !important; line-height: 32px; text-align: center; border:none; background: #e74c3c; color: white; cursor: pointer; }
        .grid-6 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* INPUT RADIO */
        .input-mode-group { display: flex; gap: 20px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-weight: normal; margin: 0; }
        .radio-label input { width: auto; margin-right: 8px; }
        
        /* BOXES */
        .result-box { margin-top: 30px; background: #e8f8f5; padding: 20px; text-align: center; border-radius: 8px; border: 1px solid #d1f2eb;}
        .management-box { background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ffeeba; }
        
        /* --- C·∫§U H√åNH GIAO DI·ªÜN M·ªöI --- */
        .config-grid { 
            display: flex; 
            align-items: stretch; /* √âp 2 c·ªôt cao b·∫±ng nhau */
        }
        .config-col { 
            flex: 1; 
            min-width: 300px;
            display: flex;
            flex-direction: column; 
        }
        
        /* ƒê∆∞·ªùng k·∫ª ngƒÉn c√°ch */
        .config-col-left {
            padding-right: 30px;    
            margin-right: 30px;     
            border-right: 2px dashed #16a085; 
        }
        
        /* Ch·ªânh l·ªÅ t√™n t·ªânh */
        .table-scroll-container td:first-child {
            padding-left: 20px; 
            font-weight: 500;
        }
        
        /* ƒê·∫©y n√∫t xu·ªëng ƒë√°y */
        .mt-auto { margin-top: auto; }
        
        /* Chi·ªÅu cao b·∫£ng */
        .table-scroll-container {
            height: 615px; 
            overflow-y: auto;
            border: 1px solid #ddd;
            background: white;
        }    
    </style>
</head>
<body>
    <div class="header">
        <div>Xin ch√†o, <strong>{{ session['user'] }}</strong> ({{ role.upper() }})</div>
        <a href="/logout" class="logout-btn">ƒêƒÉng xu·∫•t</a>
    </div>

    <div class="main-container">
        
        <div class="tab-bar">
            <button class="tab-btn {{ 'active' if active_tab == 'calc' else '' }}" onclick="openTab('calc')">‚ö° T√≠nh To√°n Solar</button>
            
            {% if role == 'admin' %}
            <button class="tab-btn {{ 'active' if active_tab == 'config' else '' }}" onclick="openTab('config')">‚öôÔ∏è C·∫•u H√¨nh</button>
            {% endif %}

            {% if role == 'admin' %}
            <button class="tab-btn {{ 'active' if active_tab == 'history' else '' }}" onclick="openTab('history')">üìú L·ªãch S·ª≠ KH</button>
            {% endif %}

            <button class="tab-btn {{ 'active' if active_tab == 'account' else '' }}" onclick="openTab('account')">üîë ƒê·ªïi M·∫≠t Kh·∫©u</button>
            
            {% if role == 'admin' %}
            <button class="tab-btn {{ 'active' if active_tab == 'users' else '' }}" onclick="openTab('users')">üë• T·∫°o User</button>
            {% endif %}
        </div>

        <div id="calc" class="tab-content {{ 'active' if active_tab == 'calc' else '' }}">
            <h2 style="color: var(--secondary); margin-top: 0; text-align: center;">D·ª± To√°n C√¥ng Su·∫•t</h2>
            <form method="POST">
                <label>T√™n Kh√°ch H√†ng:</label>
                <input type="text" name="ten_khach_hang" class="form-control" 
                       placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..." 
                       value="{{ du_lieu_nhap.get('ten_kh', '') }}" required>
                <label>Khu v·ª±c l·∫Øp ƒë·∫∑t:</label>
                <label>Khu v·ª±c l·∫Øp ƒë·∫∑t:</label>
                <select name="tinh_thanh_chon">
                    {% for ten_tinh in settings.tinh_thanh %}
                        <option value="{{ ten_tinh }}" {{ 'selected' if du_lieu_nhap.tinh_chon == ten_tinh else '' }}>{{ ten_tinh }}</option>
                    {% endfor %}
                </select>
        
                <label>M√¥ h√¨nh l·∫Øp ƒë·∫∑t:</label>
                <select name="loai_hinh" id="loai_hinh" class="form-control">
                    <option value="can_ho" {{ 'selected' if du_lieu_nhap.loai_hinh == 'can_ho' else '' }}>üè° H·ªô gia ƒë√¨nh</option>
                    <option value="kinh_doanh" {{ 'selected' if du_lieu_nhap.loai_hinh == 'kinh_doanh' else '' }}>üè¢ Kinh doanh</option>
                    <option value="san_xuat" {{ 'selected' if du_lieu_nhap.loai_hinh == 'san_xuat' else '' }}>üè≠ S·∫£n xu·∫•t</option>
                </select>
        
                <label>Nh·∫≠p li·ªáu theo:</label>
                <div class="input-mode-group">
                    <label class="radio-label">
                        <input type="radio" name="che_do_nhap" value="theo_tien" onchange="toggleUnit(this)" 
                        {{ 'checked' if du_lieu_nhap.che_do == 'theo_tien' else '' }}> 
                        S·ªë ti·ªÅn (VNƒê/Month)
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="che_do_nhap" value="theo_kwh" onchange="toggleUnit(this)" 
                        {{ 'checked' if du_lieu_nhap.che_do == 'theo_kwh' else '' }}> 
                        S·ªë ƒëi·ªán (kWh/Month)
                    </label>
                </div>
        
                <label id="input-label">
                    {% if du_lieu_nhap.che_do == 'theo_kwh' %}
                        S·∫£n l∆∞·ª£ng ti√™u th·ª• (kWh/Month):
                    {% else %}
                        Ti·ªÅn ƒëi·ªán trung b√¨nh th√°ng (VNƒê/Month):
                    {% endif %}
                </label>
                
                <input type="text" inputmode="numeric" name="gia_tri_dau_vao" id="gia_tri_input" required
                       value="{{ du_lieu_nhap.gia_tri }}" 
                       placeholder="{% if du_lieu_nhap.che_do == 'theo_kwh' %}VD: 500{% else %}VD: 2000000{% endif %}"
                       oninput="formatCurrency(this)">
                
                <div style="margin-bottom: 20px;">
                    <input type="hidden" name="he_so_nhap" id="he_so_nhap" value="{{ du_lieu_nhap.he_so }}">
                    
                    <div id="khung_dac_diem">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">ƒê·∫∑c ƒëi·ªÉm s·ª≠ d·ª•ng ƒëi·ªán:</label>
                        <select id="chon_ngu_canh" name="ngu_canh_chon" class="form-control" style="width: 100%; padding: 10px;">
                            <option value="gd_co_nguoi" {{ 'selected' if du_lieu_nhap.ngu_canh == 'gd_co_nguoi' else '' }}>üë¥üë∂ C√≥ ng∆∞·ªùi gi√†/tr·∫ª nh·ªè ·ªü nh√† (D√πng nhi·ªÅu ban ng√†y)</option>
                            <option value="gd_di_lam" {{ 'selected' if du_lieu_nhap.ngu_canh == 'gd_di_lam' else '' }}>üíº ƒêi l√†m h√†nh ch√≠nh (√çt d√πng ban ng√†y)</option>
                            <option value="gd_ban_dem" {{ 'selected' if du_lieu_nhap.ngu_canh == 'gd_ban_dem' else '' }}>üåô S·ª≠ d·ª•ng ch·ªß y·∫øu v√†o ban ƒë√™m</option>
                        </select>
                    </div>
                
                    <div id="thong_bao_he_so" style="margin-top: 10px; padding: 10px; background: #e8f6f3; color: #16a085; border-radius: 5px; display: none; font-size: 13px;">
                    </div>
                
                </div>
        
                <button type="submit" name="btn_calc" class="btn-calc">T√çNH TO√ÅN NGAY</button>
            </form>
        
            {% if ket_qua is not none %}
            <div class="result-box">
                <div>C√¥ng su·∫•t ƒë·ªÅ xu·∫•t:</div>
                <h1 style="color: var(--secondary); margin: 10px 0; font-size: 40px;">{{ ket_qua }} kWp</h1>
            </div>
            {% endif %}
        </div>

        {% if role == 'admin' %}
        <div id="config" class="tab-content {{ 'active' if active_tab == 'config' else '' }}">
            <h2 style="color: var(--dark); margin-top: 0; text-align: center; margin-bottom: 20px;">C·∫•u H√¨nh H·ªá Th·ªëng</h2>
            {% if msg_update and active_tab == 'config' %}<div class="alert">{{ msg_update }}</div>{% endif %}
        
            <div style="background:#e8f6f3; padding:15px; border-radius:5px; margin-bottom:20px; border: 1px dashed #16a085;">
                <h4 style="margin-top:0; color:#16a085;">üìÇ Nh·∫≠p t·ª´ Excel (Upload)</h4>
                <form method="POST" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center;">
                    <input type="file" name="file_excel" accept=".xlsx" required style="background:white; padding: 5px; flex: 1;">
                    <button type="submit" name="btn_upload_excel" style="background:#2980b9; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">‚¨ÜÔ∏è T·∫£i l√™n</button>
                </form>
                <p style="font-size:12px; margin:5px 0 0;">C·ªôt b·∫Øt bu·ªôc: <b>Ten_Tinh</b> v√† <b>Gio_Nang</b></p>
            </div>
        
            <div class="config-grid">
                
                <div class="config-col config-col-left">
                    <h3 style="color:#16a085; border-bottom: 2px solid #eee; padding-bottom: 10px;">üìç T·ªânh Th√†nh & Gi·ªù N·∫Øng</h3>
                    
                    <form method="POST" style="margin-bottom: 10px; display: flex; gap: 5px;">
                        <input type="text" name="new_province_name" placeholder="T√™n t·ªânh..." class="form-control" style="margin:0; flex:2;" required>
                        <input type="number" step="0.1" name="new_province_hours" placeholder="Gi·ªù" class="form-control" style="margin:0; flex:1;" required>
                        <button type="submit" name="btn_add_province" class="btn btn-primary" style="width: auto; padding: 0 15px;">+</button>
                    </form>
        
                    <form method="POST" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="table-scroll-container">
                            <table>
                                <thead><tr><th>T·ªânh/Th√†nh</th><th>Gi·ªù n·∫Øng</th><th>X√≥a</th></tr></thead>
                                <tbody>
                                    {% for ten, gio in settings['tinh_thanh'].items() %}
                                    <tr>
                                        <td>{{ ten }}</td>
                                        <td><input type="number" step="0.1" name="hours_{{ ten }}" value="{{ gio }}" style="width: 100%; padding: 5px; text-align: center;"></td>
                                        <td><button type="submit" name="btn_delete_province" value="{{ ten }}"  style="background:#e74c3c; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; line-height:24px;">&times;</button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="submit" name="btn_save_list" class="btn btn-primary mt-auto"  style="margin-top: 10px;">üíæ L∆∞u Gi·ªù N·∫Øng</button>
                    </form>
                </div>
        
                <div class="config-col">
                    <form method="POST" style="flex: 1; display: flex; flex-direction: column;">
                        <h3 style="color:#16a085; border-bottom: 2px solid #eee; padding-bottom: 10px;">üí∞ ƒê∆°n Gi√° & H·ªá S·ªë</h3>
                        
                        <div style="background: #fdfefe; padding: 15px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; color: #2980b9;">1. ƒê∆°n Gi√° ƒêi·ªán (VNƒê)</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><label>üè¢ Kinh Doanh:</label><input type="number" name="gia_kd" class="form-control" value="{{ settings.gia_kinh_doanh }}"></div>
                                <div><label>üè≠ S·∫£n Xu·∫•t:</label><input type="number" name="gia_sx" class="form-control" value="{{ settings.gia_san_xuat }}"></div>
                            </div>
                            
                            <label style="margin-top:10px; display:block;"><b>üí° B·∫≠c thang sinh ho·∫°t:</b></label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                {% for i in range(1, 7) %}
                                <div><small>B·∫≠c {{ i }}:</small><input type="number" name="b{{ i }}" class="form-control" value="{{ settings.evn_bac[i-1] }}" style="margin-bottom: 5px;"></div>
                                {% endfor %}
                            </div>
                        </div>
        
                        <div style="background: #fff8f0; padding: 15px; border: 1px solid #fce8cc; border-radius: 5px;">
                            <h4 style="margin-top: 0; color: #d35400;">2. H·ªá S·ªë S·ª≠ D·ª•ng (Scenario)</h4>
                            {% set hs = settings.get('he_so_nhom', {'gd_co_nguoi': 0.7, 'gd_di_lam': 0.4, 'gd_ban_dem': 0.3, 'kinh_doanh': 0.8, 'san_xuat': 0.9}) %}
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><label>üè† Gƒê: C√≥ ng∆∞·ªùi:</label><input type="number" step="0.01" name="hs_gd_co_nguoi" class="form-control" value="{{ hs.gd_co_nguoi }}"></div>
                                <div><label>üè† Gƒê: ƒêi l√†m:</label><input type="number" step="0.01" name="hs_gd_di_lam" class="form-control" value="{{ hs.gd_di_lam }}"></div>
                                <div><label>üè† Gƒê: D√πng ƒë√™m:</label><input type="number" step="0.01" name="hs_gd_ban_dem" class="form-control" value="{{ hs.gd_ban_dem }}"></div>
                                <div><label>üè¢ Kinh Doanh:</label><input type="number" step="0.01" name="hs_kinh_doanh" class="form-control" value="{{ hs.kinh_doanh }}"></div>
                                <div><label>üè≠ S·∫£n Xu·∫•t:</label><input type="number" step="0.01" name="hs_san_xuat" class="form-control" value="{{ hs.san_xuat }}"></div>
                            </div>
                        </div>
        
                        <button type="submit" name="btn_update_price" class="btn btn-primary mt-auto" style="margin-top: 20px;">üíæ L∆∞u C·∫•u H√¨nh </button>
                    </form>
                </div>
        
            </div>
        </div>
        {% endif %}

        <div id="account" class="tab-content {{ 'active' if active_tab == 'account' else '' }}">
            <h2 style="color: #2980b9; margin-top: 0; text-align: center;">ƒê·ªïi M·∫≠t Kh·∫©u C√° Nh√¢n</h2>
            {% if msg_update and active_tab == 'account' %}<div class="alert">{{ msg_update }}</div>{% endif %}
            
            <form method="POST" style="max-width: 400px; margin: 0 auto;">
                <label>M·∫≠t kh·∫©u hi·ªán t·∫°i:</label>
                <input type="password" name="old_pass" required>
                <label>M·∫≠t kh·∫©u m·ªõi:</label>
                <input type="password" name="new_pass" required>
                <button type="submit" name="btn_change_pass" class="btn-update" style="background: #2980b9;">L∆∞u M·∫≠t Kh·∫©u M·ªõi</button>
            </form>
        </div>

        {% if role == 'admin' %}
        <div id="users" class="tab-content {{ 'active' if active_tab == 'users' else '' }}">
            <h2 style="color: #856404; margin-top: 0; text-align: center;">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h2>
            {% if msg_update and active_tab == 'users' %}<div class="alert">{{ msg_update }}</div>{% endif %}

            <div class="management-box">
                <form method="POST" style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px;">
                    <div style="flex: 2;">
                        <label style="margin:0; font-size:12px">Username:</label>
                        <input type="text" name="new_username" placeholder="user1" autocomplete="off">
                    </div>
                    <div style="flex: 2;">
                        <label style="margin:0; font-size:12px">Password:</label>
                        <input type="text" name="new_password" placeholder="123" autocomplete="off">
                    </div>
                    <div style="flex: 1.5;">
                        <label style="margin:0; font-size:12px">Vai tr√≤:</label>
                        <select name="new_role">
                            <option value="user">User (Th∆∞·ªùng)</option>
                            <option value="admin">Admin (QTV)</option>
                        </select>
                    </div>
                    <button type="submit" name="btn_add_user" style="background:#27ae60; color:white; border:none; padding:10px; border-radius:5px; height:42px; cursor:pointer">Th√™m</button>
                </form>

                <div class="table-responsive" style="background:white; border:1px solid #eee;">
                    <table class="table table-bordered mb-0">
                        <thead class="thead-dark"><tr><th>User</th><th>Vai tr√≤</th><th class="col-center">X√≥a</th></tr></thead>
                        <tbody>
                            {% for u, info in users.items() %}
                            <tr>
                                <td>{{ u }}</td>
                                <td>
                                    {% if info.role == 'admin' %}
                                    <span style="background:#2c3e50; color:white; padding:2px 6px; border-radius:4px; font-size:12px">Admin</span>
                                    {% else %}
                                    <span style="background:#95a5a6; color:white; padding:2px 6px; border-radius:4px; font-size:12px">User</span>
                                    {% endif %}
                                </td>
                                <td class="col-center">
                                    {% if u != 'admin' and u != session['user'] %}
                                    <button onclick="if(confirm('X√≥a {{ u }}?')) { var f=document.createElement('form'); f.method='POST'; var i=document.createElement('input'); i.name='btn_delete_user'; i.value='{{ u }}'; f.appendChild(i); document.body.appendChild(f); f.submit(); }" class="btn-danger-circle">‚úï</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if role == 'admin' %}
        <div id="history" class="tab-content {{ 'active' if active_tab == 'history' else '' }}">
            <h2 style="color: #8e44ad; margin-top: 0; text-align: center;">L·ªãch S·ª≠ T√≠nh To√°n Kh√°ch H√†ng</h2>
            
            <div style="background: white; border: 1px solid #ddd; height: 600px; overflow-y: auto;">
                <table class="table">
                    <thead style="background: #f4f6f7; position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th>Th·ªùi Gian</th>
                            <th>T√™n Kh√°ch H√†ng</th>
                            <th>Khu V·ª±c - M√¥ H√¨nh</th>
                            <th>ƒê·∫ßu V√†o</th>
                            <th>K·∫øt Qu·∫£</th>
                            <th class="col-center">X√≥a</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if lich_su|length > 0 %}
                            {% for row in lich_su %}
                            <tr>
                                <td style="font-size: 13px; color: #7f8c8d;">{{ row['Th·ªùi Gian'] }}</td>
                                <td style="font-weight: bold; color: #2c3e50;">{{ row['T√™n Kh√°ch H√†ng'] }}</td>
                                <td>{{ row['Khu V·ª±c - M√¥ H√¨nh'] }}</td>
                                <td>{{ row['ƒê·∫ßu V√†o'] }}</td>
                                <td style="font-weight: bold; color: #27ae60;">{{ row['K·∫øt Qu·∫£ (kWp)'] }} kWp</td>
                                <td class="col-center">
                                    <form action="/delete_history" method="POST" onsubmit="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng n√†y?');">
                                        <input type="hidden" name="row_index" value="{{ row['id_row'] }}">
                                        <button type="submit" class="btn-danger-circle" style="background: #c0392b;">üóëÔ∏è</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ n√†o.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
        const DATA_HE_SO = {{ settings.get('he_so_nhom', {'gd_co_nguoi': 0.7, 'gd_di_lam': 0.4, 'gd_ban_dem': 0.3, 'kinh_doanh': 0.8, 'san_xuat': 0.9}) | tojson }};
        
        function openTab(id) {
            // T·∫Øt h·∫øt c√°c tab c≈©
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // B·∫≠t tab m·ªõi ƒë∆∞·ª£c ch·ªçn
            document.getElementById(id).classList.add('active');
            
            // T√¨m n√∫t b·∫•m t∆∞∆°ng ·ª©ng ƒë·ªÉ highlight (ƒë·∫£m b·∫£o ƒë√∫ng n√∫t k·ªÉ c·∫£ khi c√≥ nhi·ªÅu n√∫t)
            var buttons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].onclick.toString().includes(id)) {
                    buttons[i].classList.add('active');
                }
            }
        }

        function toggleUnit(radio) {
            document.getElementById("input-label").innerText = radio.value === "theo_tien" ? "Ti·ªÅn ƒëi·ªán trung b√¨nh th√°ng (VNƒê/Month):" : "S·∫£n l∆∞·ª£ng ti√™u th·ª• (kWh/Month):";
            document.getElementById("gia_tri_input").placeholder = radio.value === "theo_tien" ? "VD: 2000000" : "VD: 500";
            document.getElementById("gia_tri_input").value = "";
        }
        function formatCurrency(input) {
            // Ch·ªâ ch·∫°y khi ƒëang ·ªü ch·∫ø ƒë·ªô nh·∫≠p TI·ªÄN
            var mode = document.querySelector('input[name="che_do_nhap"]:checked').value;
            if (mode !== 'theo_tien') return;
            // 1. L·∫•y v·ªã tr√≠ con tr·ªè hi·ªán t·∫°i (ƒë·ªÉ nh·∫≠p gi·ªØa d√≤ng kh√¥ng b·ªã nh·∫£y)
            let cursorPosition = input.selectionStart;
            // 2. X√≥a m·ªçi k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            let originalValue = input.value.replace(/\D/g, "");
            // 3. Format l·∫°i th√†nh d·∫°ng c√≥ ch·∫•m (VD: 1000 -> 1.000)
            let formattedValue = originalValue.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            // 4. G√°n l·∫°i gi√° tr·ªã
            input.value = formattedValue;
        }
        
        function capNhatGiaoDien() {
            var loaiHinh = document.getElementById('loai_hinh').value;
            var khungDacDiem = document.getElementById('khung_dac_diem');
            var dropdown = document.getElementById('chon_ngu_canh');
            var inputAn = document.getElementById('he_so_nhap'); // ƒê√¢y l√† c√°i g·ª≠i v·ªÅ Python
            var thongBao = document.getElementById('thong_bao_he_so');
    
            if (loaiHinh === 'can_ho') {
                // --- TR∆Ø·ªúNG H·ª¢P: H·ªò GIA ƒê√åNH ---
                khungDacDiem.style.display = 'block'; // Hi·ªán menu ch·ªçn
                thongBao.style.display = 'none';      // ·∫®n th√¥ng b√°o
                if(dropdown && inputAn) {
                    var key = dropdown.value;
                    inputAn.value = DATA_HE_SO[key]; 
                }
            } else {
                // --- TR∆Ø·ªúNG H·ª¢P: KINH DOANH / S·∫¢N XU·∫§T ---
                khungDacDiem.style.display = 'none';  // ·∫®n s·∫°ch menu v√† nh√£n
                // T·ª± ƒë·ªông g√°n h·ªá s·ªë chu·∫©n v√†o √¥ ·∫©n (Logic b·∫°n c·∫ßn ki·ªÉm tra n·∫±m ·ªü ƒë√¢y üëá)
                if (loaiHinh === 'kinh_doanh') {
                    inputAn.value = DATA_HE_SO['kinh_doanh'];
                }
                if (loaiHinh === 'san_xuat') {
                    inputAn.value = DATA_HE_SO['san_xuat'];
                }
            }
        }
    
        // G·∫Øn s·ª± ki·ªán l·∫Øng nghe
        document.getElementById('loai_hinh').addEventListener('change', capNhatGiaoDien);
        document.getElementById('chon_ngu_canh').addEventListener('change', capNhatGiaoDien);
        
        // --- CH·∫†Y KHI TRANG V·ª™A T·∫¢I XONG (QUAN TR·ªåNG NH·∫§T) ---
        document.addEventListener("DOMContentLoaded", function() {
            // 1. C·∫≠p nh·∫≠t ·∫©n/hi·ªán giao di·ªán
            capNhatGiaoDien();
    
            // 2. T·ª± ƒë·ªông th√™m d·∫•u ch·∫•m v√†o √¥ ti·ªÅn (Fix l·ªói m·∫•t d·∫•u ch·∫•m sau khi t√≠nh)
            var input = document.getElementById('gia_tri_input');
            var modeRadio = document.querySelector('input[name="che_do_nhap"]:checked');
    
            if (input && input.value && modeRadio && modeRadio.value === 'theo_tien') {
                // Python tr·∫£ v·ªÅ s·ªë th·ª±c (VD: 2000000.0), ta c·∫ßn x√≥a ƒëu√¥i .0 ƒëi tr∆∞·ªõc khi format
                if (input.value.endsWith('.0')) {
                    input.value = input.value.slice(0, -2);
                }
                // G·ªçi h√†m format ngay l·∫≠p t·ª©c
                formatCurrency(input);
            }
        }); 
    </script>
</body>
</html>